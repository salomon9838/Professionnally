<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MediTrack Pro — Gestion Médicale Intelligente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #eef2ff;
      --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
      --secondary: #7209b7;
      --secondary-light: #f3e8ff;
      --secondary-gradient: linear-gradient(135deg, #7209b7 0%, #6a08a6 100%);
      --success: #4cc9f0;
      --success-light: #e6f7ff;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --danger: #e63946;
      --danger-light: #ffe6e9;
      --warning: #ffb703;
      --card-bg: #ffffff;
      --sidebar-bg: #f1f5f9;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 10px 30px rgba(67, 97, 238, 0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.2s ease;
      --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 16px;
      --radius-sm: 8px;
      --glass: rgba(255, 255, 255, 0.9);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      color: var(--dark);
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(114, 9, 183, 0.1) 0%, transparent 50%);
      z-index: -1;
    }

    /* Utilities */
    .hidden { 
      display: none !important;
    }
    
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .gap-6 { gap: 1.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .p-6 { padding: 1.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .rounded-lg { border-radius: var(--radius-sm); }
    .rounded-xl { border-radius: var(--radius); }
    .rounded-2xl { border-radius: 1.5rem; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .text-sm { font-size: 0.875rem; }
    .text-base { font-size: 1rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .cursor-pointer { cursor: pointer; }
    .w-full { width: 100%; }
    .w-auto { width: auto; }
    .max-w-4xl { max-width: 80rem; }
    .overflow-auto { overflow: auto; }
    .transition-all { transition: var(--transition); }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .mt-4 { margin-top: 1rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .my-6 { margin: 1.5rem 0; }

    /* NEW: Uppercase input styling */
    .uppercase-input {
      text-transform: uppercase !important;
    }
    
    .uppercase-input::placeholder {
      text-transform: none;
    }

    /* Table styling improvements */
    .word-like-table {
      border-collapse: collapse;
      width: 100%;
      margin: 1rem 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      background: white;
    }
    
    .word-like-table th {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
      padding: 12px 15px;
      border: 1px solid #dee2e6;
      text-align: left;
    }
    
    .word-like-table td {
      padding: 10px 15px;
      border: 1px solid #dee2e6;
    }
    
    .word-like-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    .word-like-table tr:hover {
      background-color: #e9ecef;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0); opacity: 0.5; }
      20% { transform: scale(25); opacity: 0.3; }
      100% { transform: scale(40); opacity: 0; }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(67, 97, 238, 0.5); }
      50% { box-shadow: 0 0 20px rgba(67, 97, 238, 0.8); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    
    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.8); }
      70% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    .animate-slideUp { animation: slideUp 0.5s ease-out; }
    .animate-slideDown { animation: slideDown 0.4s ease-out; }
    .animate-slideIn { animation: slideIn 0.4s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-glow { animation: glow 2s infinite; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    .animate-bounceIn { animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }
    
    .btn-secondary {
      background: var(--secondary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(114, 9, 183, 0.3);
    }
    
    .btn-secondary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(114, 9, 183, 0.25);
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-3px);
    }
    
    .btn-glass {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--dark);
    }
    
    .btn-glass:hover {
      background: white;
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }
    
    .btn-back {
      background: var(--gray-light);
      color: var(--gray);
      padding: 0.6rem 1.2rem;
    }
    
    .btn-back:hover {
      background: #dee2e6;
      transform: translateX(-3px);
    }
    
    .btn-icon {
      padding: 0.6rem;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
    }
    
    .btn-shimmer {
      background: linear-gradient(90deg, 
        var(--primary) 0%, 
        #4cc9f0 25%, 
        var(--primary) 50%, 
        #4cc9f0 75%, 
        var(--primary) 100%);
      background-size: 200% auto;
      animation: shimmer 3s infinite linear;
    }

    /* NEW: PDF/Word buttons */
    .btn-pdf {
      background: linear-gradient(135deg, #e63946 0%, #d62839 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(230, 57, 70, 0.3);
    }
    
    .btn-pdf:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(230, 57, 70, 0.25);
    }
    
    .btn-word {
      background: linear-gradient(135deg, #2b579a 0%, #1e4a8f 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(43, 87, 154, 0.3);
    }
    
    .btn-word:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(43, 87, 154, 0.25);
    }

    /* Alerts */
    .alert {
      padding: 0.875rem 1rem;
      border-radius: var(--radius-sm);
      margin: 1rem 0;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.4s ease-out;
      border-left: 4px solid;
      backdrop-filter: blur(10px);
    }
    
    .alert-success {
      background: linear-gradient(90deg, #d1e7dd, #c3e6cb);
      color: #0f5132;
      border-left-color: #198754;
    }
    
    .alert-error {
      background: linear-gradient(90deg, #f8d7da, #f5c6cb);
      color: #842029;
      border-left-color: #dc3545;
    }
    
    .alert-warning {
      background: linear-gradient(90deg, #fff3cd, #ffeaa7);
      color: #664d03;
      border-left-color: #ffc107;
    }
    
    .alert-info {
      background: linear-gradient(90deg, #cff4fc, #b8e6f9);
      color: #055160;
      border-left-color: #0dcaf0;
    }

    /* Form Controls */
    .form-group {
      margin-bottom: 1.25rem;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .form-control {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      transition: var(--transition);
      background: white;
      backdrop-filter: blur(10px);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      transform: translateY(-2px);
    }
    
    .form-control::placeholder {
      color: #a0aec0;
    }
    
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 16px 12px;
      padding-right: 2.5rem;
    }

    /* Layout */
    #authScreen,
    #appContainer {
      width: 100%;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.6s ease-out;
    }

    /* Auth Screen */
    #authScreen {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      min-height: 100vh;
      justify-content: center;
      padding: 2rem 1rem;
    }
    
    .auth-container {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.5rem;
      max-width: 500px;
      width: 100%;
      margin: 0 auto;
      animation: slideUp 0.5s ease-out;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .app-logo {
      text-align: center;
      margin-bottom: 2rem;
      animation: float 3s ease-in-out infinite;
    }
    
    .app-logo h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
    }
    
    .app-logo h1 .gradient-text {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .app-logo p {
      color: var(--gray);
      font-size: 1rem;
    }

    /* Header */
    .app-header {
      background: var(--glass);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      position: sticky;
      top: 0;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .logo {
      font-size: 1.75rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--primary);
    }
    
    .logo i {
      font-size: 1.5rem;
      animation: pulse 2s infinite;
      color: var(--primary);
    }
    
    .user-info {
      font-weight: 600;
      color: var(--gray);
      background: var(--primary-light);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(10px);
    }
    
    .user-info i {
      color: var(--primary);
    }

    /* Navigation */
    .nav-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .breadcrumb-item {
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition-fast);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
    }
    
    .breadcrumb-item:hover {
      background: var(--primary-light);
      color: var(--primary);
    }
    
    .breadcrumb-item.active {
      color: var(--primary);
      font-weight: 600;
    }
    
    .breadcrumb-separator {
      color: #ced4da;
    }
    
    .nav-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    /* Main Menu */
    #mainMenu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .menu-card {
      background: var(--glass);
      border-radius: var(--radius);
      padding: 2rem 1.5rem;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .menu-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-gradient);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }
    
    .menu-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-hover);
      border-color: var(--primary);
    }
    
    .menu-card:hover::before {
      transform: scaleX(1);
    }
    
    .menu-card i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--primary);
      animation: float 3s ease-in-out infinite;
    }
    
    .menu-card h3 {
      font-size: 1.375rem;
      margin-bottom: 0.75rem;
      color: var(--dark);
    }
    
    .menu-card p {
      color: var(--gray);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    /* Content Areas */
    .content-area {
      display: none;
    }
    
    .content-area.active {
      display: block;
      animation: slideUp 0.5s ease-out;
    }

    .content-header {
      margin-bottom: 2rem;
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .content-header h2 {
      font-size: 1.875rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .content-header p {
      color: var(--gray);
      font-size: 1rem;
    }

    /* Patient List */
    .patients-list-container {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 1rem;
      max-height: 500px;
      overflow-y: auto;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .patient-search-card {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--gray-light);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }
    
    .patient-search-card:hover {
      background: var(--primary-light);
      transform: translateX(5px);
      border-radius: var(--radius-sm);
    }
    
    .patient-search-card:last-child {
      border-bottom: none;
    }
    
    .patient-search-card .patient-info h4 {
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--dark);
    }
    
    .patient-search-card .patient-info p {
      color: var(--gray);
      font-size: 0.9rem;
    }
    
    .patient-search-card .patient-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Patient Details */
    #patientDetails {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 1.5rem;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .detail-item {
      background: var(--primary-light);
      padding: 1rem;
      border-radius: var(--radius-sm);
      backdrop-filter: blur(10px);
    }
    
    .detail-item label {
      font-size: 0.85rem;
      color: var(--gray);
      margin-bottom: 0.25rem;
      display: block;
    }
    
    .detail-item p {
      font-weight: 600;
      color: var(--dark);
    }
    
    .details-section-header {
      margin: 1.5rem 0 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--primary);
      color: var(--primary);
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .consultation-item {
      background: var(--glass);
      padding: 1.25rem;
      border-radius: var(--radius-sm);
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
    
    .consultation-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .consultation-item.other-service {
      border-left-color: var(--secondary);
      background: var(--secondary-light);
    }
    
    .consultation-item .consultation-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .consultation-item .consultation-date {
      font-weight: 600;
      color: var(--primary);
    }
    
    .consultation-item .consultation-service {
      background: var(--gray-light);
      color: var(--gray);
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.85rem;
    }

    /* Prescription Editor */
    #prescriptionContent {
      font-family: 'Courier New', 'Consolas', monospace;
      font-size: 1rem;
      min-height: 350px;
      padding: 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius-sm);
      white-space: pre-wrap;
      word-wrap: break-word;
      resize: vertical;
      background: #f8f9fa;
      line-height: 1.5;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
    
    #prescriptionContent:focus {
      border-color: var(--primary);
      background: white;
      transform: translateY(-2px);
    }
    
    .editor-toolbar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    /* Registry Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-gradient);
    }
    
    .stat-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: var(--primary);
      animation: float 3s ease-in-out infinite;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
      margin: 0.5rem 0;
      line-height: 1;
    }
    
    .stat-label {
      color: var(--gray);
      font-size: 0.95rem;
    }
    
    .disease-stats-table {
      width: 100%;
      background: var(--glass);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .disease-stats-table pre {
      margin: 0;
      padding: 1.5rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }

    /* Filters */
    .filters-container {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }

    /* Footer */
    .app-footer {
      margin-top: auto;
      padding: 1.5rem 2rem;
      text-align: center;
      color: var(--gray);
      font-size: 0.9rem;
      background: var(--glass);
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(20px);
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      max-width: 400px;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #198754 0%, #146c43 100%);
    }
    
    .notification.error {
      background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
    }
    
    .notification.warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }

    /* Progress Bar */
    .progress-bar {
      height: 4px;
      background: var(--primary-light);
      border-radius: 2px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    /* NEW: Age input styling */
    .age-input-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .age-input-group input {
      flex: 1;
    }
    
    .age-input-group select {
      flex: 0.5;
    }

    /* NEW: Service-specific templates */
    .template-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    /* NEW: Patient info header */
    .patient-info-header {
      background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
      color: white;
      padding: 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }
    
    .patient-info-header h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .patient-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .patient-info-item {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.75rem;
      border-radius: var(--radius-sm);
      backdrop-filter: blur(10px);
    }
    
    .patient-info-item label {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 0.25rem;
      display: block;
    }
    
    .patient-info-item p {
      font-weight: 600;
      font-size: 1rem;
    }

    /* NEW: Blood group styling */
    .blood-group-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .blood-group-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #dee2e6;
      background: white;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
    }
    
    .blood-group-btn.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .blood-group-btn:hover:not(.selected) {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    /* NEW: Server sync indicator */
    .sync-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      padding: 0.75rem 1.25rem;
      border-radius: 50px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .sync-indicator.syncing {
      animation: pulse 2s infinite;
    }
    
    .sync-indicator.synced {
      background: linear-gradient(135deg, #198754 0%, #146c43 100%);
      color: white;
    }
    
    .sync-indicator.error {
      background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
      color: white;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .filters-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .app-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        padding: 1rem;
      }
      #mainMenu {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .filters-grid {
        grid-template-columns: 1fr;
      }
      .details-grid {
        grid-template-columns: 1fr;
      }
      .auth-container {
        padding: 1.5rem;
      }
      .nav-breadcrumb {
        flex-wrap: wrap;
      }
      .patient-info-grid {
        grid-template-columns: 1fr;
      }
      .template-buttons {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .content-header h2 {
        font-size: 1.5rem;
      }
      .btn {
        padding: 0.625rem 1rem;
        font-size: 0.9rem;
      }
      .notification {
        left: 20px;
        right: 20px;
        max-width: none;
      }
      .editor-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(241, 241, 241, 0.5);
      border-radius: 4px;
      backdrop-filter: blur(10px);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(193, 193, 193, 0.7);
      border-radius: 4px;
      backdrop-filter: blur(10px);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(161, 161, 161, 0.9);
    }

    /* Grid utilities */
    .grid {
      display: grid;
    }
    .grid-cols-1 {
      grid-template-columns: repeat(1, 1fr);
    }
    .grid-cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }
    .grid-cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .grid-cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }
    
    .min-w-\[200px\] {
      min-width: 200px;
    }

    /* Hover effects */
    .hover-lift {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-lift:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    /* Glass effect */
    .glass {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
 
  <!-- Notification System -->
  <div id="notificationContainer"></div>

  <!-- Sync Indicator -->
  <div id="syncIndicator" class="sync-indicator hidden">
    <i class="fas fa-sync"></i>
    <span>Connexion...</span>
  </div>

  <!-- Auth Screen -->
  <div id="authScreen" class="flex items-center justify-center">
    <div class="auth-container">
      <div class="app-logo">
        <h1><i class="fas fa-heartbeat"></i> <span class="gradient-text">MediTrack Pro</span></h1>
        <p>Système de gestion médicale intelligent et sécurisé</p>
      </div>

      <div id="registerView" class="hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Créer un compte</h2>
        <form id="registerForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Prénom *</label>
              <input type="text" id="regFirstName" class="form-control uppercase-input" required />
            </div>
            <div class="form-group">
              <label>Nom *</label>
              <input type="text" id="regLastName" class="form-control uppercase-input" required />
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Nom d'utilisateur *</label>
              <input type="text" id="regUsername" class="form-control" required />
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="regEmail" class="form-control" required />
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Téléphone</label>
              <input type="text" id="regPhone" class="form-control" />
            </div>
            <div class="form-group">
              <label>Rôle *</label>
              <select id="regRole" class="form-control">
                <option>Professeur</option>
                <option>Médecin</option>
                <option>Infirmier(ère)</option>
                <option>TSO</option>
                <option>TAR</option>
                <option>TRIM</option>
                <option>Sage-femme</option>
                <option>Orthophoniste</option>
                <option>Kiné</option>
                <option>Opticien</option>
                <option>Administrateur</option>
              </select>
            </div>
          </div>
          
          <div class="form-group mb-4">
            <label>Service *</label>
            <select id="regService" class="form-control">
              <option>Anesthésie-Réanimation</option>
              <option>Anatomo-pathologie</option>
              <option>Administration</option>
              <option>Autre</option>
              <option>Cardiologie</option>
              <option>Chirurgie générale</option>
              <option>Chirurgie pédiatrique</option>
              <option>Chirurgie Viscérale</option>
              <option>Consultation générale</option>
              <option>Dermatologie</option>
              <option>Gastroentérologie</option>
              <option>Gynécologie</option>
              <option>Hématologie</option>
              <option>Infertilité</option>
              <option>Kinésithérapie</option>
              <option>Laboratoire</option>
              <option>Médecine Interne</option>
              <option>Néphrologie</option>
              <option>Neurochirurgie</option>
              <option>Neurologie</option>
              <option>Odontologie/Stomatologie</option>
              <option>Ophtalmologie</option>
              <option>Optométrie</option>
              <option>ORL</option>
              <option>Pédiatrie</option>
              <option>Pneumologie</option>
              <option>Psychiatrie</option>
              <option>Radiologie/Imagerie médicale</option>
              <option>Réanimation médicale et polysalle</option>
              <option>Rhumatologie</option>
              <option>Sage-femme/Obstétrique</option>
              <option>Scanner</option>
              <option>Transfusion sanguine</option>
              <option>Traumatologie</option>
              <option>Urgences</option>
              <option>Urologie</option>
            </select>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="form-group">
              <label>Mot de passe *</label>
              <input type="password" id="regPassword" class="form-control" required minlength="6" />
            </div>
            <div class="form-group">
              <label>Confirmer *</label>
              <input type="password" id="regConfirmPassword" class="form-control" required />
            </div>
          </div>
          
          <div id="authAlert"></div>
          <button type="submit" class="btn btn-primary w-full animate-pulse">
            <i class="fas fa-user-plus"></i> S'inscrire
          </button>
          <div class="text-center mt-4">
            <a href="#" onclick="toggleAuthView('login')" class="text-primary font-semibold hover:underline transition-all">
              <i class="fas fa-sign-in-alt"></i> Déjà inscrit ? Se connecter
            </a>
          </div>
        </form>
      </div>

      <div id="loginView">
        <h2 class="text-2xl font-bold mb-6 text-center animate-bounceIn">Se connecter</h2>
        <form id="loginForm">
          <div class="form-group mb-4">
            <label>Email ou Nom d'utilisateur *</label>
            <input type="text" id="userEmail" class="form-control" required />
          </div>
          <div class="form-group mb-6">
            <label>Mot de passe *</label>
            <input type="password" id="userPassword" class="form-control" required />
          </div>
          <div id="authAlert"></div>
          <button type="submit" class="btn btn-primary w-full animate-pulse">
            <i class="fas fa-sign-in-alt"></i> Connexion
          </button>
          <div class="text-center mt-4">
            <a href="#" onclick="toggleAuthView('register')" class="text-primary font-semibold hover:underline transition-all">
              <i class="fas fa-user-plus"></i> Pas encore de compte ? S'inscrire
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- App Container -->
  <div id="appContainer" class="hidden flex-col">
    <div class="app-header animate-slideDown">
      <div class="logo">
        <i class="fas fa-heartbeat"></i>
        <span>MediTrack Pro</span>
      </div>
      <div class="user-info" id="currentUserInfo"></div>
    </div>

    <div class="p-6 flex-1">
      <!-- Navigation Breadcrumb -->
      <div id="navBreadcrumb" class="nav-breadcrumb hidden">
        <div id="breadcrumbContent"></div>
      </div>

      <!-- Navigation Controls -->
      <div id="navControls" class="nav-controls hidden">
        <button class="btn btn-back" onclick="goBack()">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
        <button class="btn btn-outline" onclick="showMainMenu()">
          <i class="fas fa-home"></i> Accueil
        </button>
      </div>

      <!-- Main Menu -->
      <div id="mainMenu">
        <div class="menu-card animate-bounceIn" onclick="showSection('newConsultation')">
          <i class="fas fa-user-plus"></i>
          <h3>Nouvelle Consultation</h3>
          <p>Créer un dossier patient</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.1s" onclick="showSection('oldConsultation')">
          <i class="fas fa-history"></i>
          <h3>Ancienne Consultation</h3>
          <p>Rechercher un patient</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.2s" onclick="showSection('registry')">
          <i class="fas fa-chart-bar"></i>
          <h3>Registre & Statistiques</h3>
          <p>Données agrégées</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.3s" onclick="showSection('settings')">
          <i class="fas fa-cog"></i>
          <h3>Paramètres</h3>
          <p>Gérer votre profil</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.4s" onclick="clearAuthData()">
          <i class="fas fa-sign-out-alt"></i>
          <h3>Déconnexion</h3>
          <p>Quitter la session</p>
        </div>
      </div>

      <!-- New Consultation -->
      <div id="newConsultation" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-user-plus"></i> Nouvelle Consultation</h2>
          <p>Créez un nouveau dossier patient</p>
        </div>
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <form id="newPatientForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Nom complet du patient *</label>
                <input type="text" id="patientName" class="form-control uppercase-input" required />
              </div>
              <div class="form-group">
                <label>Âge *</label>
                <div class="age-input-group">
                  <input type="number" id="patientAge" class="form-control" required min="0" max="120" placeholder="Âge" />
                  <select id="patientAgeUnit" class="form-control">
                    <option value="ans">Ans</option>
                    <option value="mois">Mois</option>
                    <option value="jours">Jours</option>
                    <option value="heures">Heures</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Sexe *</label>
                <select id="patientGender" class="form-control" required>
                  <option value="M">Masculin</option>
                  <option value="F">Féminin</option>
                </select>
              </div>
              <div class="form-group">
                <label>Profession</label>
                <input type="text" id="patientProfession" class="form-control uppercase-input" />
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Téléphone</label>
                <input type="text" id="patientPhone" class="form-control" />
              </div>
              <div class="form-group">
                <label>Adresse</label>
                <input type="text" id="patientAddress" class="form-control uppercase-input" />
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Groupe Sanguin</label>
                <div class="blood-group-selector">
                  <button type="button" class="blood-group-btn" onclick="selectBloodGroup('A+')">A+</button>
                  <button type="button" class="blood-group-btn" onclick="selectBloodGroup('A-')">A-</button>
                  <button type="button" class="blood-group-btn" onclick="selectBloodGroup('B+')">B+</button>
                  <button type="button" class="blood-group-btn" onclick="selectBloodGroup('B-')">B-</button>
                  <button type="button" class="blood-group-btn" onclick="selectBloodGroup('AB+')">AB+</button>
                  <button type="button" class="blood-group-btn" onclick="selectBloodGroup('AB-')">AB-</button>
                  <button type="button" class="blood-group-btn" onclick="selectBloodGroup('O+')">O+</button>
                  <button type="button" class="blood-group-btn" onclick="selectBloodGroup('O-')">O-</button>
                </div>
                <input type="hidden" id="patientBloodGroup" />
              </div>
              <div class="form-group">
                <label>Rhésus</label>
                <select id="patientRhesus" class="form-control">
                  <option value="">Sélectionner</option>
                  <option value="+">Positif (+)</option>
                  <option value="-">Négatif (-)</option>
                </select>
              </div>
            </div>
            
            <div class="form-group mb-6">
              <label>Service d'enregistrement initial *</label>
              <select id="serviceType" class="form-control" required>
                <option>Anesthésie-Réanimation</option>
                <option>Anatomo-pathologie</option>
                <option>Administration</option>
                <option>Autre</option>
                <option>Cardiologie</option>
                <option>Chirurgie générale</option>
                <option>Chirurgie pédiatrique</option>
                <option>Chirurgie Viscérale</option>
                <option>Consultation générale</option>
                <option>Dermatologie</option>
                <option>Gastroentérologie</option>
                <option>Gynécologie</option>
                <option>Hématologie</option>
                <option>Infertilité</option>
                <option>Kinésithérapie</option>
                <option>Laboratoire</option>
                <option>Médecine Interne</option>
                <option>Néphrologie</option>
                <option>Neurochirurgie</option>
                <option>Neurologie</option>
                <option>Odontologie/Stomatologie</option>
                <option>Ophtalmologie</option>
                <option>Optométrie</option>
                <option>ORL</option>
                <option>Pédiatrie</option>
                <option>Pneumologie</option>
                <option>Psychiatrie</option>
                <option>Radiologie/Imagerie médicale</option>
                <option>Réanimation médicale et polysalle</option>
                <option>Rhumatologie</option>
                <option>Sage-femme/Obstétrique</option>
                <option>Scanner</option>
                <option>Transfusion sanguine</option>
                <option>Traumatologie</option>
                <option>Urgences</option>
                <option>Urologie</option>
              </select>
            </div>
            
            <div id="newConsultAlert"></div>
            <div class="flex gap-4">
              <button type="submit" class="btn btn-primary animate-glow">
                <i class="fas fa-arrow-right"></i> Continuer vers la prescription
              </button>
              <button type="button" class="btn btn-outline" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Patient Info Header (Displayed in Prescription Editor) -->
      <div id="patientInfoHeader" class="patient-info-header hidden">
        <h3><i class="fas fa-user-injured"></i> Informations du Patient</h3>
        <div class="patient-info-grid" id="patientInfoContent">
          <!-- Patient info will be dynamically inserted here -->
        </div>
      </div>

      <!-- Prescription Editor -->
      <div id="prescriptionEditor" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-file-medical"></i> Éditeur de Prescription</h2>
          <p id="currentPatientNameDisplay2" class="text-gray"></p>
        </div>
        
        <!-- Service-specific Templates -->
        <div id="templateButtons" class="template-buttons"></div>
        
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <div class="editor-toolbar">
            <button class="btn btn-secondary animate-pulse" onclick="addSection()">
              <i class="fas fa-plus"></i> Ajouter Section
            </button>
            <button class="btn btn-secondary animate-pulse" onclick="addWordLikeTable()">
              <i class="fas fa-table"></i> Ajouter Tableau
            </button>
            <button class="btn btn-outline" onclick="showEditPatientModal()">
              <i class="fas fa-edit"></i> Modifier Patient
            </button>
            <button class="btn btn-word" onclick="exportToWord()">
              <i class="fas fa-file-word"></i> Exporter Word
            </button>
            <button class="btn btn-pdf" onclick="exportToPDF()">
              <i class="fas fa-file-pdf"></i> Exporter PDF
            </button>
          </div>
          
          <form id="prescriptionForm">
            <textarea id="prescriptionContent" class="w-full" placeholder="Commencez à rédiger la prescription ici..."></textarea>
            <div id="editorAlert" class="mt-3"></div>
            <div class="flex gap-3 mt-4">
              <button type="submit" class="btn btn-primary btn-shimmer">
                <i class="fas fa-arrow-right"></i> Suivant : Résumé Médical
              </button>
              <button type="button" class="btn btn-outline" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Medical Summary -->
      <div id="medicalSummary" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-clipboard-list"></i> Résumé Médical</h2>
          <p id="currentPatientNameDisplay3" class="text-gray"></p>
        </div>
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <form onsubmit="event.preventDefault(); saveConsultation();">
            <div class="form-group mb-6">
              <label>Type de maladie *</label>
              <input type="text" id="diseaseType" class="form-control uppercase-input" required />
            </div>
            
            <div class="form-group mb-6">
              <label>Observations utiles</label>
              <textarea id="summaryText" class="form-control uppercase-input" rows="3" placeholder="Notes additionnelles sur l'état du patient..."></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Nom du soignant *</label>
                <input type="text" id="doctorName" class="form-control uppercase-input" required readonly />
              </div>
              <div class="form-group">
                <label>Contact du soignant</label>
                <input type="text" id="doctorContact" class="form-control" />
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Service (Consultation) *</label>
                <input type="text" id="doctorService" class="form-control uppercase-input" required readonly />
              </div>
              <div class="form-group">
                <label>Centre de consultation *</label>
                <input type="text" id="consultationCenter" class="form-control uppercase-input" required />
              </div>
            </div>
            
            <div class="flex gap-3 mt-4">
              <button type="submit" class="btn btn-primary animate-glow">
                <i class="fas fa-save"></i> Enregistrer Consultation
              </button>
              <button type="button" class="btn btn-outline" onclick="showSection('prescriptionEditor')">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Old Consultation -->
      <div id="oldConsultation" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-history"></i> Ancienne Consultation</h2>
          <p>Service : <span id="listServiceDisplay" class="font-bold text-primary"></span></p>
        </div>
        
        <div class="filters-container mb-6 animate-slideIn">
          <div class="form-group">
            <label><i class="fas fa-search"></i> Rechercher un patient (nom, ID, téléphone)</label>
            <input type="text" id="searchInput" class="form-control uppercase-input" oninput="debouncedSearch()" 
                   placeholder="Entrez au moins 2 caractères..." />
          </div>
        </div>
        
        <div id="searchLoader" class="hidden text-center">
          <div class="loading-spinner"></div>
          <p class="text-gray mt-2">Recherche en cours...</p>
        </div>
        
        <div id="patientsListContainer" class="hidden">
          <div id="patientListContent"></div>
        </div>
        
        <div id="patientDetails" class="hidden"></div>
        
        <div id="noResults" class="hidden text-center py-12">
          <i class="fas fa-user-md text-5xl text-gray-300 mb-4 animate-float"></i>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">Aucun patient trouvé</h3>
          <p class="text-gray-500">Aucun patient ne correspond à votre recherche dans ce service.</p>
        </div>
      </div>

      <!-- Registry -->
      <div id="registry" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-chart-bar"></i> Registre & Statistiques</h2>
          <p>Filtrez et analysez les données médicales</p>
        </div>
        
        <div class="filters-container animate-slideIn">
          <div class="filters-grid">
            <div class="form-group">
              <label><i class="fas fa-disease"></i> Maladie</label>
              <input type="text" id="diseaseSearchInput" class="form-control uppercase-input" oninput="debouncedUpdateStats()" placeholder="Rechercher..." />
            </div>
            <div class="form-group">
              <label><i class="fas fa-calendar-alt"></i> Date de début</label>
              <input type="date" id="dateFilterStart" class="form-control" oninput="debouncedUpdateStats()" />
            </div>
            <div class="form-group">
              <label><i class="fas fa-calendar-alt"></i> Date de fin</label>
              <input type="date" id="dateFilterEnd" class="form-control" oninput="debouncedUpdateStats()" />
            </div>
            <div class="form-group">
              <label><i class="fas fa-hospital"></i> Centre</label>
              <select id="centerFilter" class="form-control" oninput="debouncedUpdateStats()">
                <option value="all">Tous les centres</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-stethoscope"></i> Service</label>
              <select id="serviceFilter" class="form-control" oninput="debouncedUpdateStats()">
                <option value="all">Tous les services</option>
              </select>
            </div>
            <div class="form-group flex items-end">
              <button class="btn btn-primary w-full" onclick="exportData()">
                <i class="fas fa-file-csv"></i> Exporter CSV
              </button>
            </div>
          </div>
        </div>
        
        <div class="stats-grid my-6">
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-label">Patients uniques</div>
            <div class="stat-value" id="totalPatients">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-file-medical"></i>
            </div>
            <div class="stat-label">Total consultations</div>
            <div class="stat-value" id="totalConsultations">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-ambulance"></i>
            </div>
            <div class="stat-label">Consultations aux urgences</div>
            <div class="stat-value" id="urgencesCount">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-label">Maladies distinctes</div>
            <div class="stat-value" id="diseaseCount">0</div>
          </div>
        </div>
        
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <h3 class="font-bold text-xl mb-4 flex items-center gap-2">
            <i class="fas fa-ranking-star text-primary animate-pulse"></i>
            Top 10 Maladies
          </h3>
          <div id="diseaseStats" class="disease-stats-table"></div>
        </div>
      </div>

      <!-- Settings -->
      <div id="settings" class="content-area">
        <div id="settingsMenu" class="content-header">
          <h2><i class="fas fa-cog"></i> Paramètres</h2>
          <p>Gérez votre compte et vos préférences</p>
          <div class="flex gap-3 mt-4 flex-wrap">
            <button class="btn btn-secondary" onclick="showSettingsSubSection('profileSection')">
              <i class="fas fa-user"></i> Profil
            </button>
            <button class="btn btn-secondary" onclick="showSettingsSubSection('passwordSection')">
              <i class="fas fa-lock"></i> Mot de passe
            </button>
            <button class="btn btn-outline" onclick="goBack()">
              <i class="fas fa-arrow-left"></i> Retour
            </button>
          </div>
        </div>

        <div id="profileSection" class="hidden">
          <div class="glass p-6 rounded-xl shadow hover-lift mt-4">
            <h3 class="font-bold text-xl mb-4">Modifier votre profil</h3>
            <form id="profileForm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Prénom</label>
                  <input type="text" id="editFirstName" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Nom</label>
                  <input type="text" id="editLastName" class="form-control" disabled />
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Nom d'utilisateur</label>
                  <input type="text" id="editUsername" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="editEmail" class="form-control" required />
                </div>
              </div>
              
              <div class="form-group mb-6">
                <label>Téléphone</label>
                <input type="text" id="editPhone" class="form-control" />
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Rôle</label>
                  <input type="text" id="editRole" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Service</label>
                  <input type="text" id="editService" class="form-control" disabled />
                </div>
              </div>
              
              <div id="profileAlert"></div>
              <div class="flex gap-3">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Mettre à jour
                </button>
                <button type="button" class="btn btn-outline" onclick="showSettingsSubSection('')">
                  <i class="fas fa-times"></i> Annuler
                </button>
              </div>
            </form>
          </div>
        </div>

        <div id="passwordSection" class="hidden">
          <div class="glass p-6 rounded-xl shadow hover-lift mt-4">
            <h3 class="font-bold text-xl mb-4">Changer le mot de passe</h3>
            <form id="passwordForm">
              <div class="form-group mb-6">
                <label>Ancien mot de passe</label>
                <input type="password" id="oldPassword" class="form-control" required />
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Nouveau mot de passe</label>
                  <input type="password" id="newPassword" class="form-control" required minlength="6" />
                </div>
                <div class="form-group">
                  <label>Confirmer</label>
                  <input type="password" id="confirmNewPassword" class="form-control" required />
                </div>
              </div>
              
              <div id="securityAlert"></div>
              <div class="flex gap-3">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-key"></i> Changer le mot de passe
                </button>
                <button type="button" class="btn btn-outline" onclick="showSettingsSubSection('')">
                  <i class="fas fa-times"></i> Annuler
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Patient Modal -->
    <div id="editPatientModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-primary">
              <i class="fas fa-edit"></i> Modifier Patient
            </h3>
            <button onclick="closeEditPatientModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <form id="editPatientForm">
            <div class="form-group mb-4">
              <label>Nom complet du patient</label>
              <input type="text" id="editPatientName" class="form-control uppercase-input" readonly />
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="form-group">
                <label>Sexe</label>
                <input type="text" id="editPatientGender" class="form-control uppercase-input" readonly />
              </div>
              <div class="form-group">
                <label>Âge *</label>
                <div class="age-input-group">
                  <input type="number" id="editPatientAge" class="form-control" required min="0" max="120" placeholder="Âge" />
                  <select id="editPatientAgeUnit" class="form-control">
                    <option value="ans">Ans</option>
                    <option value="mois">Mois</option>
                    <option value="jours">Jours</option>
                    <option value="heures">Heures</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="form-group">
                <label>Profession</label>
                <input type="text" id="editPatientProfession" class="form-control uppercase-input" />
              </div>
              <div class="form-group">
                <label>Téléphone</label>
                <input type="text" id="editPatientPhone" class="form-control" />
              </div>
            </div>
            
            <div class="form-group mb-4">
              <label>Adresse</label>
              <input type="text" id="editPatientAddress" class="form-control uppercase-input" />
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div class="form-group">
                <label>Groupe Sanguin</label>
                <div class="blood-group-selector">
                  <button type="button" class="blood-group-btn" onclick="selectEditBloodGroup('A+')">A+</button>
                  <button type="button" class="blood-group-btn" onclick="selectEditBloodGroup('A-')">A-</button>
                  <button type="button" class="blood-group-btn" onclick="selectEditBloodGroup('B+')">B+</button>
                  <button type="button" class="blood-group-btn" onclick="selectEditBloodGroup('B-')">B-</button>
                  <button type="button" class="blood-group-btn" onclick="selectEditBloodGroup('AB+')">AB+</button>
                  <button type="button" class="blood-group-btn" onclick="selectEditBloodGroup('AB-')">AB-</button>
                  <button type="button" class="blood-group-btn" onclick="selectEditBloodGroup('O+')">O+</button>
                  <button type="button" class="blood-group-btn" onclick="selectEditBloodGroup('O-')">O-</button>
                </div>
                <input type="hidden" id="editPatientBloodGroup" />
              </div>
              <div class="form-group">
                <label>Rhésus</label>
                <select id="editPatientRhesus" class="form-control">
                  <option value="">Sélectionner</option>
                  <option value="+">Positif (+)</option>
                  <option value="-">Négatif (-)</option>
                </select>
              </div>
            </div>
            
            <div id="editPatientAlert"></div>
            <div class="flex gap-3 mt-6">
              <button type="submit" class="btn btn-primary flex-1">
                <i class="fas fa-save"></i> Enregistrer modifications
              </button>
              <button type="button" class="btn btn-outline" onclick="closeEditPatientModal()">
                <i class="fas fa-times"></i> Annuler
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="app-footer">
      <p><i class="fas fa-heartbeat text-primary"></i> MediTrack Pro &copy; 2025 — Système de gestion médicale sécurisé</p>
      <p class="text-sm mt-2 text-gray-500">Version 2.0 • <span id="currentYear"></span></p>
    </div>
  </div>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@7.8.0/build/index.min.js"></script>

  <script>
    // ==================================
    // DONNÉES ET FONCTIONS PRINCIPALES
    // ==================================
    let patients = [];
    let consultations = [];
    let currentPatient = null;
    let currentPrescription = ''; 
    let storedUser = JSON.parse(localStorage.getItem('storedUser')) || null;
    let navigationHistory = [];
    let searchTimeout = null;
    let statsTimeout = null;
    let currentSection = 'mainMenu';
    let selectedBloodGroup = '';
    let selectedEditBloodGroup = '';

    // ================================
    // NOUVELLE FONCTIONNALITÉ : INTEROPÉRABILITÉ
    // ================================
    // Simulation d'une base de données partagée (en production, remplacer par un vrai backend)
    const SERVER_URL = 'https://jsonplaceholder.typicode.com/posts'; // URL factice pour l'exemple
    let isOnline = navigator.onLine;
    let syncQueue = [];
    let isSyncing = false;

    // Fonction pour synchroniser les données avec le "serveur"
    async function syncWithServer() {
      if (!isOnline) {
        updateSyncIndicator('offline');
        return;
      }

      updateSyncIndicator('syncing');
      
      try {
        // Récupérer les données du serveur (simulation)
        const serverData = await fetchServerData();
        
        if (serverData) {
          // Fusionner les données locales avec les données du serveur
          mergeData(serverData);
          saveData();
          showNotification('Données synchronisées avec succès', 'success');
        }
        
        // Envoyer les données locales au serveur (simulation)
        await sendLocalData();
        
        updateSyncIndicator('synced');
      } catch (error) {
        console.error('Erreur de synchronisation:', error);
        updateSyncIndicator('error');
        showNotification('Erreur de synchronisation', 'error');
      }
    }

    // Simulation de récupération des données du serveur
    async function fetchServerData() {
      // En production, remplacer par un vrai appel API
      const savedServerData = localStorage.getItem('serverData');
      return savedServerData ? JSON.parse(savedServerData) : { patients: [], consultations: [] };
    }

    // Simulation d'envoi des données au serveur
    async function sendLocalData() {
      const dataToSend = {
        patients: patients,
        consultations: consultations,
        timestamp: new Date().toISOString()
      };
      
      // En production, remplacer par un vrai appel API
      localStorage.setItem('serverData', JSON.stringify(dataToSend));
      return true;
    }

    // Fusionner les données
    function mergeData(serverData) {
      // Fusionner les patients
      serverData.patients.forEach(serverPatient => {
        const localPatientIndex = patients.findIndex(p => p.id === serverPatient.id);
        
        if (localPatientIndex === -1) {
          // Patient non présent localement, l'ajouter
          patients.push(serverPatient);
        } else {
          // Patient présent localement, garder la version la plus récente
          const localPatient = patients[localPatientIndex];
          const serverDate = new Date(serverPatient.updatedAt || serverPatient.createdAt);
          const localDate = new Date(localPatient.updatedAt || localPatient.createdAt);
          
          if (serverDate > localDate) {
            patients[localPatientIndex] = serverPatient;
          }
        }
      });

      // Fusionner les consultations
      serverData.consultations.forEach(serverConsultation => {
        const localConsultationIndex = consultations.findIndex(c => c.id === serverConsultation.id);
        
        if (localConsultationIndex === -1) {
          consultations.push(serverConsultation);
        } else {
          const localConsultation = consultations[localConsultationIndex];
          const serverDate = new Date(serverConsultation.updatedAt || serverConsultation.createdAt);
          const localDate = new Date(localConsultation.updatedAt || localConsultation.createdAt);
          
          if (serverDate > localDate) {
            consultations[localConsultationIndex] = serverConsultation;
          }
        }
      });
    }

    // Mettre à jour l'indicateur de synchronisation
    function updateSyncIndicator(status) {
      const indicator = document.getElementById('syncIndicator');
      if (!indicator) return;
      
      indicator.classList.remove('hidden', 'syncing', 'synced', 'error');
      
      switch(status) {
        case 'syncing':
          indicator.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span>Synchronisation...</span>';
          indicator.classList.add('syncing');
          break;
        case 'synced':
          indicator.innerHTML = '<i class="fas fa-check-circle"></i> <span>Synchronisé</span>';
          indicator.classList.add('synced');
          setTimeout(() => indicator.classList.add('hidden'), 3000);
          break;
        case 'error':
          indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Erreur de sync</span>';
          indicator.classList.add('error');
          break;
        case 'offline':
          indicator.innerHTML = '<i class="fas fa-wifi-slash"></i> <span>Hors ligne</span>';
          break;
      }
      
      indicator.classList.remove('hidden');
    }

    // Vérifier la connexion réseau
    window.addEventListener('online', () => {
      isOnline = true;
      updateSyncIndicator('syncing');
      setTimeout(syncWithServer, 1000);
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      updateSyncIndicator('offline');
    });

    // ================================
    // FONCTIONS UTILITAIRES
    // ================================
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      const container = document.getElementById('notificationContainer');
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function showAlert(elementId, message, type = 'info') {
      const alertDiv = document.getElementById(elementId);
      if (!alertDiv) return;
      
      alertDiv.innerHTML = `
        <div class="alert alert-${type}">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
          ${message}
        </div>
      `;
    }

    function updateStoredUser(user) {
      storedUser = user;
      localStorage.setItem('storedUser', JSON.stringify(user));
    }

    // ================================
    // NOUVELLE FONCTIONNALITÉ : GESTION DU SANG
    // ================================
    function selectBloodGroup(group) {
      selectedBloodGroup = group;
      document.getElementById('patientBloodGroup').value = group;
      
      // Mettre à jour l'interface
      document.querySelectorAll('.blood-group-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent === group) {
          btn.classList.add('selected');
        }
      });
    }

    function selectEditBloodGroup(group) {
      selectedEditBloodGroup = group;
      document.getElementById('editPatientBloodGroup').value = group;
      
      document.querySelectorAll('#editPatientForm .blood-group-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent === group) {
          btn.classList.add('selected');
        }
      });
    }

    // ================================
    // FONCTIONS D'AUTHENTIFICATION
    // ================================
    function showAuthScreen() {
      document.getElementById('appContainer').classList.add('hidden');
      document.getElementById('authScreen').classList.remove('hidden');
      if (storedUser) {
        toggleAuthView('login');
      } else {
        toggleAuthView('register');
      }
    }
    
    function toggleAuthView(view) {
      const authAlert = document.getElementById('authAlert');
      if (authAlert) authAlert.innerHTML = '';
      
      document.getElementById('registerView').classList.add('hidden');
      document.getElementById('loginView').classList.add('hidden');
      
      if (view === 'register') {
        document.getElementById('registerView').classList.remove('hidden');
      } else if (view === 'login') {
        document.getElementById('loginView').classList.remove('hidden');
      }
    }
    
    function clearAuthData() {
      localStorage.removeItem('isLoggedIn');
      navigationHistory = [];
      showAuthScreen();
      showNotification('Déconnexion réussie !', 'success');
    }
    
    function checkAuth() {
      if (localStorage.getItem('isLoggedIn') === 'true' && storedUser) {
        startApp();
      } else {
        showAuthScreen();
      }
    }

    // ================================
    // GESTION DES FORMULAIRES
    // ================================
    document.getElementById('loginForm').onsubmit = function(e) {
      e.preventDefault();
      const emailOrUsername = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;
      
      if (storedUser && 
          (storedUser.email === emailOrUsername || storedUser.username === emailOrUsername) && 
          storedUser.password === password) {
        localStorage.setItem('isLoggedIn', 'true');
        showAlert('authAlert', 'Connexion réussie ! Redirection...', 'success');
        document.getElementById('loginForm').reset();
        setTimeout(startApp, 1000);
      } else {
        showAlert('authAlert', 'Identifiants incorrects. Veuillez vérifier vos informations ou vous inscrire.', 'error');
      }
    };

    document.getElementById('registerForm').onsubmit = function(e) {
      e.preventDefault();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      
      if (password !== confirmPassword) {
        showAlert('authAlert', 'Le mot de passe et sa confirmation ne correspondent pas.', 'error');
        return;
      }
      if (password.length < 6) {
        showAlert('authAlert', 'Le mot de passe doit contenir au moins 6 caractères.', 'error');
        return;
      }
      
      const newUser = {
        firstName: document.getElementById('regFirstName').value.toUpperCase(),
        lastName: document.getElementById('regLastName').value.toUpperCase(),
        username: document.getElementById('regUsername').value,
        email: document.getElementById('regEmail').value,
        phone: document.getElementById('regPhone').value,
        role: document.getElementById('regRole').value,
        service: document.getElementById('regService').value,
        password: password,
      };
      
      updateStoredUser(newUser);
      showAlert('authAlert', 'Inscription réussie ! Veuillez vous connecter.', 'success');
      document.getElementById('registerForm').reset();
      toggleAuthView('login');
    };

    document.getElementById('profileForm').onsubmit = function(e) {
      e.preventDefault();
      const updatedUser = {
        ...storedUser,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value,
      };
      updateStoredUser(updatedUser);
      showAlert('profileAlert', 'Profil mis à jour !', 'success');
      document.getElementById('currentUserInfo').textContent = `${storedUser.firstName} ${storedUser.lastName} (${storedUser.role} - ${storedUser.service})`;
      setTimeout(() => showSettingsSubSection(''), 2000);
    };

    document.getElementById('passwordForm').onsubmit = function(e) {
      e.preventDefault();
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;
      
      if (!storedUser) {
        showAlert('securityAlert', 'Erreur utilisateur. Veuillez vous déconnecter et réessayer.', 'error');
        return;
      }
      if (oldPassword !== storedUser.password) {
        showAlert('securityAlert', 'L\'ancien mot de passe est incorrect.', 'error');
        return;
      }
      if (newPassword !== confirmNewPassword) {
        showAlert('securityAlert', 'Le nouveau mot de passe et sa confirmation ne correspondent pas.', 'error');
        return;
      }
      if (newPassword.length < 6) {
        showAlert('securityAlert', 'Le nouveau mot de passe doit contenir au moins 6 caractères.', 'error');
        return;
      }
      
      const updatedUser = { ...storedUser, password: newPassword };
      updateStoredUser(updatedUser);
      document.getElementById('passwordForm').reset();
      showAlert('securityAlert', 'Mot de passe mis à jour avec succès ! Veuillez vous reconnecter.', 'success');
      setTimeout(clearAuthData, 2000); 
    };

    // ================================
    // NAVIGATION ET ANIMATIONS
    // ================================
    function navigateTo(sectionId) {
      if (currentSection === sectionId) return;
      
      navigationHistory.push(currentSection);
      updateBreadcrumb(sectionId);
      showSection(sectionId);
    }

    function goBack() {
      if (navigationHistory.length > 0) {
        const previousSection = navigationHistory.pop();
        showSection(previousSection);
        updateBreadcrumb(previousSection);
      } else {
        showMainMenu();
      }
    }

    function updateBreadcrumb(sectionId) {
      const breadcrumbContent = document.getElementById('breadcrumbContent');
      const navControls = document.getElementById('navControls');
      const navBreadcrumb = document.getElementById('navBreadcrumb');
      
      if (sectionId === 'mainMenu') {
        navBreadcrumb.classList.add('hidden');
        navControls.classList.add('hidden');
        return;
      }
      
      navBreadcrumb.classList.remove('hidden');
      navControls.classList.remove('hidden');
      
      let breadcrumb = '';
      const sections = {
        'newConsultation': 'Nouvelle Consultation',
        'prescriptionEditor': 'Éditeur de Prescription',
        'medicalSummary': 'Résumé Médical',
        'oldConsultation': 'Ancienne Consultation',
        'registry': 'Registre & Statistiques',
        'settings': 'Paramètres'
      };
      
      breadcrumb = `
        <div class="breadcrumb-item" onclick="showMainMenu()">
          <i class="fas fa-home"></i> Accueil
        </div>
        <div class="breadcrumb-separator">/</div>
        <div class="breadcrumb-item active">
          <i class="fas fa-${getSectionIcon(sectionId)}"></i> ${sections[sectionId]}
        </div>
      `;
      
      breadcrumbContent.innerHTML = breadcrumb;
    }

    function getSectionIcon(sectionId) {
      const icons = {
        'newConsultation': 'user-plus',
        'prescriptionEditor': 'file-medical',
        'medicalSummary': 'clipboard-list',
        'oldConsultation': 'history',
        'registry': 'chart-bar',
        'settings': 'cog'
      };
      return icons[sectionId] || 'folder';
    }

    function showSection(sectionId) {
      // Cacher toutes les sections de contenu
      document.querySelectorAll('.content-area').forEach(area => {
        area.classList.remove('active');
      });

      // Cacher le menu principal
      document.getElementById('mainMenu').classList.add('hidden');
      document.getElementById('mainMenu').classList.remove('visible');

      // Afficher la section demandée
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.add('active');
      }

      // Mettre à jour la navigation
      currentSection = sectionId;
      updateBreadcrumb(sectionId);
      
      // Logique spécifique à chaque section
      handleSectionSpecificLogic(sectionId);
    }

    function handleSectionSpecificLogic(sectionId) {
      switch(sectionId) {
        case 'oldConsultation':
          debouncedSearch();
          break;
        case 'prescriptionEditor':
          document.getElementById('prescriptionContent').value = currentPrescription || '';
          const editorAlert = document.getElementById('editorAlert');
          if (editorAlert) editorAlert.innerHTML = '';
          updatePatientInfoHeader();
          loadServiceTemplates();
          break;
        case 'settings':
          const settingsMenu = document.getElementById('settingsMenu');
          if (settingsMenu) {
            settingsMenu.classList.remove('hidden');
          }
          document.querySelectorAll('#settings > div').forEach(div => {
            if (div.id !== 'settingsMenu') {
              div.classList.add('hidden');
            }
          });
          populateProfileForm();
          break;
        case 'newConsultation':
          selectedBloodGroup = '';
          document.querySelectorAll('.blood-group-btn').forEach(btn => {
            btn.classList.remove('selected');
          });
          document.getElementById('patientBloodGroup').value = '';
          document.getElementById('patientRhesus').value = '';
          break;
      }
    }

    function showMainMenu() {
      navigationHistory = [];
      currentSection = 'mainMenu';
      
      // Cacher toutes les sections
      document.querySelectorAll('.content-area').forEach(section => {
        section.classList.remove('active');
      });
      
      // Cacher les contrôles de navigation
      const navControls = document.getElementById('navControls');
      const navBreadcrumb = document.getElementById('navBreadcrumb');
      if (navControls) navControls.classList.add('hidden');
      if (navBreadcrumb) navBreadcrumb.classList.add('hidden');
      
      // Afficher le menu principal
      const mainMenu = document.getElementById('mainMenu');
      if (mainMenu) {
        mainMenu.classList.remove('hidden');
      }
    }

    function showSettingsSubSection(subSectionId) {
      const settingsMenu = document.getElementById('settingsMenu');
      if (settingsMenu) {
        settingsMenu.classList.add('hidden');
      }
      
      document.querySelectorAll('#settings > div').forEach(div => {
        if (div.id !== 'settingsMenu') {
          div.classList.add('hidden');
        }
      });
      
      if (subSectionId) {
        const subSection = document.getElementById(subSectionId);
        if (subSection) {
          subSection.classList.remove('hidden');
        }
      } else {
        if (settingsMenu) {
          settingsMenu.classList.remove('hidden');
        }
      }
    }

    // ================================
    // NOUVELLE FONCTIONNALITÉ : EN-TÊTE PATIENT
    // ================================
    function updatePatientInfoHeader() {
      if (!currentPatient) return;
      
      const header = document.getElementById('patientInfoHeader');
      const content = document.getElementById('patientInfoContent');
      
      if (!header || !content) return;
      
      header.classList.remove('hidden');
      
      const ageDisplay = currentPatient.ageUnit ? 
        `${currentPatient.age} ${currentPatient.ageUnit}` : 
        `${currentPatient.age} ans`;
      
      content.innerHTML = `
        <div class="patient-info-item">
          <label><i class="fas fa-id-card"></i> ID Patient</label>
          <p>${currentPatient.id}</p>
        </div>
        <div class="patient-info-item">
          <label><i class="fas fa-user"></i> Nom Complet</label>
          <p>${currentPatient.name}</p>
        </div>
        <div class="patient-info-item">
          <label><i class="fas fa-birthday-cake"></i> Âge</label>
          <p>${ageDisplay}</p>
        </div>
        <div class="patient-info-item">
          <label><i class="fas fa-venus-mars"></i> Sexe</label>
          <p>${currentPatient.gender === 'M' ? 'Masculin' : 'Féminin'}</p>
        </div>
        <div class="patient-info-item">
          <label><i class="fas fa-tint"></i> Groupe Sanguin</label>
          <p>${currentPatient.bloodGroup || 'N/A'}</p>
        </div>
        <div class="patient-info-item">
          <label><i class="fas fa-plus-circle"></i> Rhésus</label>
          <p>${currentPatient.rhesus || 'N/A'}</p>
        </div>
      `;
    }

    // ================================
    // NOUVELLE FONCTIONNALITÉ : MODIFIER PATIENT
    // ================================
    function showEditPatientModal() {
      if (!currentPatient) {
        showNotification('Aucun patient sélectionné', 'error');
        return;
      }
      
      // Remplir le formulaire avec les données actuelles
      document.getElementById('editPatientName').value = currentPatient.name;
      document.getElementById('editPatientGender').value = currentPatient.gender === 'M' ? 'Masculin' : 'Féminin';
      document.getElementById('editPatientAge').value = currentPatient.age;
      document.getElementById('editPatientAgeUnit').value = currentPatient.ageUnit || 'ans';
      document.getElementById('editPatientProfession').value = currentPatient.profession || '';
      document.getElementById('editPatientPhone').value = currentPatient.phone || '';
      document.getElementById('editPatientAddress').value = currentPatient.address || '';
      
      // Groupe sanguin
      selectedEditBloodGroup = currentPatient.bloodGroup || '';
      document.getElementById('editPatientBloodGroup').value = selectedEditBloodGroup;
      document.querySelectorAll('#editPatientForm .blood-group-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent === selectedEditBloodGroup) {
          btn.classList.add('selected');
        }
      });
      
      document.getElementById('editPatientRhesus').value = currentPatient.rhesus || '';
      
      // Afficher le modal
      document.getElementById('editPatientModal').classList.remove('hidden');
    }

    function closeEditPatientModal() {
      document.getElementById('editPatientModal').classList.add('hidden');
      document.getElementById('editPatientAlert').innerHTML = '';
    }

    document.getElementById('editPatientForm').onsubmit = function(e) {
      e.preventDefault();
      
      // Mettre à jour le patient
      currentPatient.age = document.getElementById('editPatientAge').value;
      currentPatient.ageUnit = document.getElementById('editPatientAgeUnit').value;
      currentPatient.profession = document.getElementById('editPatientProfession').value.toUpperCase();
      currentPatient.phone = document.getElementById('editPatientPhone').value;
      currentPatient.address = document.getElementById('editPatientAddress').value.toUpperCase();
      currentPatient.bloodGroup = document.getElementById('editPatientBloodGroup').value;
      currentPatient.rhesus = document.getElementById('editPatientRhesus').value;
      currentPatient.updatedAt = new Date().toISOString();
      
      // Mettre à jour dans la liste des patients
      const patientIndex = patients.findIndex(p => p.id === currentPatient.id);
      if (patientIndex !== -1) {
        patients[patientIndex] = currentPatient;
      }
      
      saveData();
      updatePatientInfoHeader();
      
      showNotification('Informations du patient mises à jour', 'success');
      closeEditPatientModal();
    };

    // ================================
    // FONCTIONS DE L'APPLICATION
    // ================================
    function startApp() {
      loadData();
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      
      document.getElementById('currentUserInfo').textContent = `${storedUser.firstName} ${storedUser.lastName} (${storedUser.role} - ${storedUser.service})`;
      document.getElementById('listServiceDisplay').textContent = storedUser.service;
      document.getElementById('currentYear').textContent = new Date().getFullYear();
      
      showMainMenu();
      updateStats();
      populateRegistryFilters();
      
      // Initialiser les débounceurs
      window.debouncedSearch = debounce(searchPatients, 300);
      window.debouncedUpdateStats = debounce(updateStats, 300);
      
      // Synchroniser avec le serveur
      setTimeout(syncWithServer, 2000);
    }

    // ================================
    // GESTION DES PATIENTS
    // ================================
    document.getElementById('newPatientForm').onsubmit = function(e) {
      e.preventDefault();
      const patientName = document.getElementById('patientName').value.trim().toUpperCase();
      const patientId = 'PAT-' + Date.now().toString().slice(-6);
      
      // Vérifier si le patient existe déjà (interopérabilité)
      const existingPatient = patients.find(p => p.name.toUpperCase() === patientName.toUpperCase());
      
      if (existingPatient) {
        currentPatient = existingPatient;
        showAlert('newConsultAlert', `Le patient "${patientName}" (ID: ${existingPatient.id}) existe déjà. Voulez-vous continuer avec ce patient?`, 'info');
        
        // Mettre à jour l'en-tête du patient
        setTimeout(() => {
          updatePatientInfoHeader();
          navigateTo('prescriptionEditor');
        }, 1000);
        return;
      }

      const patient = {
        id: patientId,
        name: patientName,
        age: document.getElementById('patientAge').value,
        ageUnit: document.getElementById('patientAgeUnit').value,
        gender: document.getElementById('patientGender').value,
        profession: document.getElementById('patientProfession').value.toUpperCase(),
        phone: document.getElementById('patientPhone').value,
        address: document.getElementById('patientAddress').value.toUpperCase(),
        bloodGroup: document.getElementById('patientBloodGroup').value,
        rhesus: document.getElementById('patientRhesus').value,
        service: document.getElementById('serviceType').value,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      currentPatient = patient;
      patients.push(patient);
      saveData();

      document.getElementById('currentPatientNameDisplay2').textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;
      document.getElementById('newPatientForm').reset();
      currentPrescription = '';

      navigateTo('prescriptionEditor');
    };

    // ================================
    // NOUVELLE FONCTIONNALITÉ : TEMPLATES PAR SERVICE
    // ================================
    function loadServiceTemplates() {
      const templateButtons = document.getElementById('templateButtons');
      if (!templateButtons) return;
      
      templateButtons.innerHTML = '';
      
      const service = storedUser?.service || 'Consultation générale';
      
      const templates = {
        'Cardiologie': [
          { name: 'ECG', content: 'ECG :\n- Fréquence cardiaque: ___ bpm\n- Rythme: ___ \n- Ondes P: ___ \n- Complexe QRS: ___ \n- Segment ST: ___ \n- Onde T: ___ \n- Intervalle QT: ___ ms\n\nConclusion: ___' },
          { name: 'Échocardiographie', content: 'ÉCHOGRAPHIE CARDIAQUE :\n\nDimensions (mm):\n- VG télédiastolique: ___\n- VG télésystolique: ___\n- OG: ___\n- OD: ___\n\nFonction VG:\n- FE: ___%\n- Fraction de raccourcissement: ___%\n\nValvulopathies: ___' },
          { name: 'Holter', content: 'HOLTER ECG 24H :\n\nRythme de base: ___\nFC min: ___ bpm\nFC max: ___ bpm\nFC moyenne: ___ bpm\n\nExtrasystoles:\n- SVES: ___/24h\n- VES: ___/24h\n\nPauses: ___ (max ___ ms)\n\nConclusion: ___' }
        ],
        'Ophtalmologie': [
          { name: 'Acuité Visuelle', content: 'ACUITÉ VISUELLE :\n\nOD: ___/10 sans correction\n      ___/10 avec correction\n\nOG: ___/10 sans correction\n      ___/10 avec correction\n\nAddition: ___' },
          { name: 'Tension Oculaire', content: 'TONOMÉTRIE :\n\nOD: ___ mmHg\nOG: ___ mmHg\n\nHeure de mesure: ___:___\n\nMéthode: ___' },
          { name: 'Fond d\'œil', content: 'FOND D\'ŒIL :\n\nPapille: ___\nVaisseaux: ___\nRétine périphérique: ___\nMacula: ___\n\nConclusion: ___' }
        ],
        'Urgences': [
          { name: 'Traumatologie', content: 'TRAUMATOLOGIE :\n\nMécanisme: ___\nHeure: ___:___\n\nExamen:\n- Glasgow: ___/15\n- TA: ___/___ mmHg\n- FC: ___ bpm\n- SpO2: ___%\n- Glycémie: ___ g/L\n\nLésions: ___\n\nConduite à tenir: ___' },
          { name: 'Médecine', content: 'URGENCES MÉDICALES :\n\nMotif: ___\n\nAntécédents: ___\n\nExamen:\n- TA: ___/___ mmHg\n- FC: ___ bpm\n- Temp: ___°C\n- FR: ___/min\n- SpO2: ___%\n- EVA: ___/10\n\nDiagnostic: ___\nTraitement: ___' }
        ],
        'Médecine Interne': [
          { name: 'Bilan Standard', content: 'BILAN BIOLOGIQUE :\n\nNFS:\n- GB: ___ G/L\n- Hb: ___ g/dL\n- Hte: ___%\n- Plaquettes: ___ G/L\n\nBiochimie:\n- Glycémie: ___ g/L\n- Urée: ___ mmol/L\n- Créatinine: ___ μmol/L\n- Na: ___ mmol/L\n- K: ___ mmol/L\n\nConclusion: ___' }
        ]
      };
      
      const serviceTemplates = templates[service] || templates['Médecine Interne'];
      
      serviceTemplates.forEach(template => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-outline';
        button.innerHTML = `<i class="fas fa-file-medical"></i> ${template.name}`;
        button.onclick = () => insertTemplate(template.content);
        templateButtons.appendChild(button);
      });
    }

    function insertTemplate(content) {
      const textarea = document.getElementById('prescriptionContent');
      if (textarea) {
        textarea.value += '\n\n' + content + '\n';
        textarea.focus();
        showNotification('Template inséré', 'success');
      }
    }

    // ================================
    // PRESCRIPTION
    // ================================
    document.getElementById('prescriptionForm').onsubmit = function(e) {
      e.preventDefault();
      goToSummary();
    };

    function goToSummary() {
      currentPrescription = document.getElementById('prescriptionContent').value;
      
      const patientNameDisplay = document.getElementById('currentPatientNameDisplay3');
      if (patientNameDisplay) {
        patientNameDisplay.textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;
      }
      
      document.getElementById('doctorName').value = `${storedUser.firstName} ${storedUser.lastName}`.toUpperCase();
      document.getElementById('doctorContact').value = storedUser.phone || storedUser.email;
      document.getElementById('doctorService').value = storedUser.service;
      document.getElementById('consultationCenter').value = 'CENTRE HOSPITALIER UNIVERSITAIRE';

      const editorAlert = document.getElementById('editorAlert');
      if (editorAlert) editorAlert.innerHTML = '';
      
      navigateTo('medicalSummary');
    }

    function saveConsultation() {
      if (!currentPatient) {
        showNotification('Erreur: Le patient actuel n\'est pas défini. Veuillez recommencer la consultation.', 'error');
        navigateTo('newConsultation');
        return;
      }
      
      const diseaseType = document.getElementById('diseaseType').value.toUpperCase();
      const doctorName = document.getElementById('doctorName').value;
      const doctorService = document.getElementById('doctorService').value;
      const consultationCenter = document.getElementById('consultationCenter').value.toUpperCase();
      
      if (!diseaseType || !doctorName || !doctorService || !consultationCenter) {
        showNotification('Veuillez remplir tous les champs obligatoires du Résumé Médical (marqués par *).', 'error');
        return;
      }

      const consultation = {
        id: 'CONS-' + Date.now(),
        patientId: currentPatient.id,
        date: new Date().toISOString().split('T')[0],
        generalDiagnosis: '',
        treatmentDuration: 0,
        prescriptionContent: currentPrescription,
        disease: diseaseType,
        observations: document.getElementById('summaryText').value.toUpperCase(),
        doctorName: doctorName,
        doctorContact: document.getElementById('doctorContact').value,
        service: doctorService,
        center: consultationCenter,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      consultations.push(consultation);
      saveData();
      
      // Synchroniser avec le serveur
      syncWithServer();
      
      showNotification(`Consultation enregistrée pour le patient ${consultation.patientId} !`, 'success');
      
      // Réinitialiser
      currentPatient = null;
      currentPrescription = '';
      document.getElementById('patientInfoHeader').classList.add('hidden');
      
      // Animation de succès
      const saveBtn = document.querySelector('#medicalSummary .btn-primary');
      const originalHTML = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="fas fa-check"></i> Enregistré !';
      saveBtn.classList.add('animate-glow');
      
      setTimeout(() => {
        saveBtn.innerHTML = originalHTML;
        saveBtn.classList.remove('animate-glow');
        showMainMenu();
      }, 1500);
    }

    // ================================
    // RECHERCHE DE PATIENTS (AMÉLIORÉE POUR INTEROPÉRABILITÉ)
    // ================================
    function searchPatients() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const listContentDiv = document.getElementById('patientListContent');
      const patientsListContainer = document.getElementById('patientsListContainer');
      const searchLoader = document.getElementById('searchLoader');
      const noResults = document.getElementById('noResults');
      
      const serviceDuSoignant = storedUser ? storedUser.service : 'Consultation générale';
      const listServiceDisplay = document.getElementById('listServiceDisplay');
      if (listServiceDisplay) {
        listServiceDisplay.textContent = serviceDuSoignant;
      }

      // Afficher le loader
      if (patientsListContainer) patientsListContainer.classList.add('hidden');
      if (noResults) noResults.classList.add('hidden');
      if (searchLoader) searchLoader.classList.remove('hidden');

      setTimeout(() => {
        // RECHERCHE GLOBALE (tous les services) pour l'interopérabilité
        let patientsToShow = patients.slice();
        
        if (query.length >= 2) {
          patientsToShow = patientsToShow.filter(p => 
            p.name.toLowerCase().includes(query) || 
            p.id.toLowerCase().includes(query) || 
            (p.phone && p.phone.toLowerCase().includes(query))
          );
        } else {
          patientsToShow = patientsToShow.slice(0, 15);
        }
        
        // Trier par date de dernière consultation (tous services confondus)
        patientsToShow.sort((a, b) => {
          const lastA = consultations.filter(c => c.patientId === a.id)
            .sort((x, y) => new Date(y.date) - new Date(x.date))[0]?.date || '1970-01-01';
          const lastB = consultations.filter(c => c.patientId === b.id)
            .sort((x, y) => new Date(y.date) - new Date(x.date))[0]?.date || '1970-01-01';
          return new Date(lastB) - new Date(lastA);
        });

        if (searchLoader) searchLoader.classList.add('hidden');

        if (patientsToShow.length === 0) {
          if (noResults) {
            noResults.classList.remove('hidden');
          }
          if (patientsListContainer) {
            patientsListContainer.classList.add('hidden');
          }
        } else {
          const resultsHtml = patientsToShow.map(p => {
            // Trouver toutes les consultations de ce patient (tous services)
            const patientConsultations = consultations.filter(c => c.patientId === p.id);
            const lastConsultation = patientConsultations
              .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
              
            const lastConsultDate = lastConsultation ? new Date(lastConsultation.date).toLocaleDateString('fr-FR') : 'N/A';
            const serviceCount = new Set(patientConsultations.map(c => c.service)).size;
            
            return `
            <div class="patient-search-card" onclick="showPatientDetails('${p.id}')">
              <div class="patient-info">
                <h4>${p.name}</h4>
                <p>${p.age} ${p.ageUnit || 'ans'} • ${p.gender === 'M' ? 'Homme' : 'Femme'} • ID: ${p.id}</p>
                <small class="text-primary">
                  <i class="fas fa-hospital"></i> ${serviceCount} service(s) consulté(s)
                </small>
              </div>
              <div class="text-right">
                <small>Dernière consult. : ${lastConsultDate}</small>
                <div class="patient-actions mt-2">
                  <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); continueConsultation('${p.id}')">
                    <i class="fas fa-edit"></i> Continuer
                  </button>
                </div>
              </div>
            </div>
            `;
          }).join('');
          
          if (listContentDiv) {
            listContentDiv.innerHTML = resultsHtml;
          }
          if (patientsListContainer) {
            patientsListContainer.classList.remove('hidden');
          }
        }

        const patientDetails = document.getElementById('patientDetails');
        if (patientDetails) {
          patientDetails.classList.add('hidden');
        }
      }, 300);
    }

    function showPatientDetails(patientId, showAll = false) {
      currentPatient = patients.find(p => p.id === patientId);

      if (!currentPatient) {
        showNotification("Patient non trouvé.", "error");
        return;
      }

      const patientDetails = document.getElementById('patientDetails');
      if (patientDetails) {
        patientDetails.classList.remove('hidden');
        
        const ageDisplay = currentPatient.ageUnit ? 
          `${currentPatient.age} ${currentPatient.ageUnit}` : 
          `${currentPatient.age} ans`;
        
        patientDetails.innerHTML = `
          <div class="details-grid">
            <div class="detail-item">
              <label>ID Patient</label>
              <p>${currentPatient.id}</p>
            </div>
            <div class="detail-item">
              <label>Nom Complet</label>
              <p><strong>${currentPatient.name}</strong></p>
            </div>
            <div class="detail-item">
              <label>Âge</label>
              <p>${ageDisplay}</p>
            </div>
            <div class="detail-item">
              <label>Sexe</label>
              <p>${currentPatient.gender === 'M' ? 'Masculin' : 'Féminin'}</p>
            </div>
            <div class="detail-item">
              <label>Groupe Sanguin</label>
              <p>${currentPatient.bloodGroup || 'N/A'}</p>
            </div>
            <div class="detail-item">
              <label>Rhésus</label>
              <p>${currentPatient.rhesus || 'N/A'}</p>
            </div>
            <div class="detail-item">
              <label>Profession</label>
              <p>${currentPatient.profession || 'N/A'}</p>
            </div>
            <div class="detail-item">
              <label>Téléphone</label>
              <p>${currentPatient.phone || 'N/A'}</p>
            </div>
            <div class="detail-item">
              <label>Adresse</label>
              <p>${currentPatient.address || 'N/A'}</p>
            </div>
            <div class="detail-item">
              <label>Service d'Enregistrement</label>
              <p>${currentPatient.service || 'N/A'}</p>
            </div>
          </div>
          <div id="consultationHistory"></div>
          <div class="flex gap-3 mt-4">
            <button class="btn btn-primary" onclick="continueConsultation('${currentPatient.id}')">
              <i class="fas fa-edit"></i> Continuer la consultation
            </button>
            <button class="btn btn-outline" onclick="showAllHistory('${currentPatient.id}')">
              <i class="fas fa-history"></i> Voir tout l'historique
            </button>
          </div>
        `;
      }

      renderHistory(patientId, showAll);
    }

    function continueConsultation(patientId) {
      currentPatient = patients.find(p => p.id === patientId);
      if (!currentPatient) return;
      
      const display = document.getElementById('currentPatientNameDisplay2');
      if (display) {
        display.textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;
      }
      currentPrescription = '';
      const prescriptionContent = document.getElementById('prescriptionContent');
      if (prescriptionContent) {
        prescriptionContent.value = '';
      }
      
      navigateTo('prescriptionEditor');
    }

    function renderHistory(patientId, showAll = false) {
      const serviceDuSoignant = storedUser ? storedUser.service : 'Consultation générale';
      const historyDiv = document.getElementById('consultationHistory');
      if (!historyDiv) return;
      
      let patientConsultations = consultations
        .filter(c => c.patientId === patientId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      if (!showAll) {
        // Pour l'interopérabilité, montrer toutes les consultations mais mettre en évidence celles du service actuel
        patientConsultations = patientConsultations;
      }
      
      let historyHtml = `<h3 class="details-section-header">
        <i class="fas fa-calendar-check"></i>
        ${showAll ? 'Historique complet' : `Historique (Tous services)`} 
        <span class="badge">${patientConsultations.length}</span>
      </h3>`;
      
      if (patientConsultations.length === 0) {
        historyHtml += `<p class="text-gray text-center py-4">Aucune consultation trouvée.</p>`;
      } else {
        patientConsultations.forEach((c, index) => {
          const isCurrentService = c.service === serviceDuSoignant;
          const cardClass = `consultation-item ${isCurrentService ? '' : 'other-service'}`;
          const serviceNote = `<span class="consultation-service">${c.service}</span>`;
          
          historyHtml += `
          <div class="${cardClass}">
            <div class="consultation-header">
              <span class="consultation-date">
                <i class="fas fa-calendar"></i> ${new Date(c.date).toLocaleDateString('fr-FR')}
              </span>
              ${serviceNote}
            </div>
            <div class="mb-3">
              <strong><i class="fas fa-disease"></i> Type de Maladie :</strong> ${c.disease || 'N/A'}
            </div>
            <div class="mb-3">
              <strong><i class="fas fa-user-md"></i> Soignant :</strong> ${c.doctorName || 'N/A'}
            </div>
            <div class="mb-3">
              <strong><i class="fas fa-file-prescription"></i> Prescription :</strong>
              <div class="mt-2 p-3 bg-light rounded border">
                <pre style="margin: 0; white-space: pre-wrap;">${c.prescriptionContent || 'N/A'}</pre>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
              <div><strong><i class="fas fa-phone"></i> Contact :</strong> ${c.doctorContact || 'N/A'}</div>
              <div><strong><i class="fas fa-hospital"></i> Centre :</strong> ${c.center || 'N/A'}</div>
            </div>
          </div>
          `;
        });
      }
      
      historyDiv.innerHTML = historyHtml;
    }

    function showAllHistory(patientId) {
      renderHistory(patientId, true);
    }

    // ================================
    // ÉDITEUR DE PRESCRIPTION AMÉLIORÉ
    // ================================
    function addWordLikeTable() {
      const contentArea = document.getElementById('prescriptionContent');
      if (!contentArea) return;
      
      const tableId = 'table-' + Date.now();
      const tableHTML = `
\n\n<!-- Début du tableau ${tableId} -->
<table class="word-like-table">
  <thead>
    <tr>
      <th>Colonne 1</th>
      <th>Colonne 2</th>
      <th>Colonne 3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Ligne 1, Cellule 1</td>
      <td>Ligne 1, Cellule 2</td>
      <td>Ligne 1, Cellule 3</td>
    </tr>
    <tr>
      <td>Ligne 2, Cellule 1</td>
      <td>Ligne 2, Cellule 2</td>
      <td>Ligne 2, Cellule 3</td>
    </tr>
    <tr>
      <td>Ligne 3, Cellule 1</td>
      <td>Ligne 3, Cellule 2</td>
      <td>Ligne 3, Cellule 3</td>
    </tr>
  </tbody>
</table>
<!-- Fin du tableau ${tableId} -->\n\n`;
      
      contentArea.value += tableHTML;
      showNotification('Tableau Word-like ajouté', 'success');
    }

    function addSection() {
      const contentArea = document.getElementById('prescriptionContent');
      if (!contentArea) return;
      
      const sectionTitle = prompt("Titre de la section:", "NOUVELLE SECTION");
      if (sectionTitle) {
        const newSection = `\n\n=== ${sectionTitle.toUpperCase()} ===\n\n`;
        contentArea.value += newSection;
      }
    }

    // ================================
    // NOUVELLE FONCTIONNALITÉ : EXPORT PDF/WORD
    // ================================
    async function exportToPDF() {
      if (!currentPatient) {
        showNotification('Aucun patient sélectionné', 'error');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // En-tête
      doc.setFontSize(20);
      doc.setTextColor(67, 97, 238);
      doc.text('PRESCRIPTION MÉDICALE', 105, 20, null, null, 'center');
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Patient: ${currentPatient.name}`, 20, 40);
      doc.text(`ID: ${currentPatient.id}`, 20, 48);
      doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, 20, 56);
      doc.text(`Service: ${storedUser?.service || 'N/A'}`, 20, 64);
      doc.text(`Médecin: ${storedUser?.firstName || ''} ${storedUser?.lastName || ''}`, 20, 72);
      
      // Ligne de séparation
      doc.setDrawColor(67, 97, 238);
      doc.setLineWidth(0.5);
      doc.line(20, 80, 190, 80);
      
      // Contenu de la prescription
      doc.setFontSize(11);
      const prescriptionText = document.getElementById('prescriptionContent').value;
      const splitText = doc.splitTextToSize(prescriptionText, 170);
      doc.text(splitText, 20, 90);
      
      // Pied de page
      doc.setFontSize(10);
      doc.setTextColor(128, 128, 128);
      doc.text('Document généré par MediTrack Pro', 105, 280, null, null, 'center');
      
      // Sauvegarder le PDF
      doc.save(`Prescription_${currentPatient.id}_${new Date().toISOString().split('T')[0]}.pdf`);
      showNotification('PDF généré avec succès', 'success');
    }

    function exportToWord() {
      if (!currentPatient) {
        showNotification('Aucun patient sélectionné', 'error');
        return;
      }
      
      const prescriptionText = document.getElementById('prescriptionContent').value;
      
      // Créer le contenu HTML pour le document Word
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .header { color: #4361ee; font-size: 24px; text-align: center; margin-bottom: 30px; }
            .patient-info { margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
            .prescription-content { white-space: pre-wrap; font-family: 'Courier New', monospace; margin-top: 20px; }
            .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="header">PRESCRIPTION MÉDICALE</div>
          <div class="patient-info">
            <strong>Patient:</strong> ${currentPatient.name}<br>
            <strong>ID:</strong> ${currentPatient.id}<br>
            <strong>Date:</strong> ${new Date().toLocaleDateString('fr-FR')}<br>
            <strong>Service:</strong> ${storedUser?.service || 'N/A'}<br>
            <strong>Médecin:</strong> ${storedUser?.firstName || ''} ${storedUser?.lastName || ''}
          </div>
          <div class="prescription-content">${prescriptionText}</div>
          <div class="footer">Document généré par MediTrack Pro</div>
        </body>
        </html>
      `;
      
      // Créer un blob et un lien de téléchargement
      const blob = new Blob([htmlContent], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Prescription_${currentPatient.id}_${new Date().toISOString().split('T')[0]}.doc`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('Document Word généré avec succès', 'success');
    }

    // ================================
    // REGISTRE ET STATISTIQUES
    // ================================
    function populateRegistryFilters() {
      const uniqueCenters = [...new Set(consultations.map(c => c.center).filter(Boolean))];
      const centerFilter = document.getElementById('centerFilter');
      if (centerFilter) {
        centerFilter.innerHTML = '<option value="all">Tous les centres</option>';
        uniqueCenters.forEach(center => {
          centerFilter.innerHTML += `<option value="${center}">${center}</option>`;
        });
      }

      const allServices = [
        'Anesthésie-Réanimation', 'Anatomo-pathologie', 'Administration', 'Autre',
        'Cardiologie', 'Chirurgie générale', 'Chirurgie pédiatrique', 'Chirurgie Viscérale',
        'Consultation générale', 'Dermatologie', 'Gastroentérologie', 'Gynécologie',
        'Hématologie', 'Infertilité', 'Kinésithérapie', 'Laboratoire', 'Médecine Interne',
        'Néphrologie', 'Neurochirurgie', 'Neurologie', 'Odontologie/Stomatologie',
        'Ophtalmologie', 'Optométrie', 'ORL', 'Pédiatrie', 'Pneumologie', 'Psychiatrie',
        'Radiologie/Imagerie médicale', 'Réanimation médicale et polysalle', 'Rhumatologie',
        'Sage-femme/Obstétrique', 'Scanner', 'Transfusion sanguine', 'Traumatologie',
        'Urgences', 'Urologie'
      ].sort(); // Tri alphabétique
      
      const serviceFilter = document.getElementById('serviceFilter');
      if (serviceFilter) {
        serviceFilter.innerHTML = '<option value="all">Tous les services</option>';
        allServices.forEach(service => {
          serviceFilter.innerHTML += `<option value="${service}">${service}</option>`;
        });
      }
    }

    function updateStats() {
      const diseaseSearch = document.getElementById('diseaseSearchInput')?.value.toUpperCase() || '';
      const dateStart = document.getElementById('dateFilterStart')?.value || '';
      const dateEnd = document.getElementById('dateFilterEnd')?.value || '';
      const centerFilterValue = document.getElementById('centerFilter')?.value || 'all';
      const serviceFilterValue = document.getElementById('serviceFilter')?.value || 'all';
      
      let filteredConsultations = consultations.filter(c => {
        const consultDate = new Date(c.date);
        if (diseaseSearch && !c.disease.toUpperCase().includes(diseaseSearch)) return false;
        if (dateStart && consultDate < new Date(dateStart)) return false;
        if (dateEnd) {
          const endDate = new Date(dateEnd);
          endDate.setDate(endDate.getDate() + 1);
          if (consultDate >= endDate) return false;
        }
        if (centerFilterValue !== 'all' && c.center !== centerFilterValue) return false;
        if (serviceFilterValue !== 'all' && c.service !== serviceFilterValue) return false;
        return true;
      });
      
      const totalConsultations = filteredConsultations.length;
      const urgencesCount = filteredConsultations.filter(c => c.service === 'Urgences').length;
      const patientIds = new Set(filteredConsultations.map(c => c.patientId));
      const totalPatients = patientIds.size;
      
      const totalPatientsEl = document.getElementById('totalPatients');
      const totalConsultationsEl = document.getElementById('totalConsultations');
      const urgencesCountEl = document.getElementById('urgencesCount');
      const diseaseCountEl = document.getElementById('diseaseCount');
      
      if (totalPatientsEl) totalPatientsEl.textContent = totalPatients;
      if (totalConsultationsEl) totalConsultationsEl.textContent = totalConsultations;
      if (urgencesCountEl) urgencesCountEl.textContent = urgencesCount;
      
      const diseaseCount = {};
      const diseaseServiceMap = {};
      
      filteredConsultations.forEach(c => {
        const normalizedDisease = c.disease.trim().toUpperCase();
        diseaseCount[normalizedDisease] = (diseaseCount[normalizedDisease] || 0) + 1;
        if (!diseaseServiceMap[normalizedDisease]) {
          diseaseServiceMap[normalizedDisease] = { service: c.service, center: c.center };
        }
      });
      
      if (diseaseCountEl) diseaseCountEl.textContent = Object.keys(diseaseCount).length;
      
      const diseaseStatsDiv = document.getElementById('diseaseStats');
      const sortedDiseases = Object.entries(diseaseCount).sort(([, a], [, b]) => b - a);
      
      let tableContent = '';
      const col1Width = 25;
      const col2Width = 15;
      const col3Width = 12;
      const col4Width = 12;
      
      const createSeparator = () => {
        return '+'.padEnd(col1Width + 1, '-') + '+'.padEnd(col2Width + 1, '-') + '+'.padEnd(col3Width + 1, '-') + '+'.padEnd(col4Width + 1, '-') + '+\n';
      };
      
      if (sortedDiseases.length === 0) {
        tableContent = '<p class="text-center py-4 text-gray">Aucune donnée correspondante</p>';
      } else {
        tableContent += createSeparator();
        tableContent += '| ' + 'Maladie'.padEnd(col1Width - 1) + '| ' + 'Total'.padEnd(col2Width - 1) + '| ' + 'Service'.padEnd(col3Width - 1) + '| ' + 'Centre'.padEnd(col4Width - 1) + '|\n';
        tableContent += createSeparator();
        
        sortedDiseases.slice(0, 10).forEach(([disease, count]) => {
          const info = diseaseServiceMap[disease] || {};
          const maladieDisplay = disease.length > col1Width ? disease.substring(0, col1Width - 2) + '..' : disease.padEnd(col1Width);
          const countDisplay = String(count).padEnd(col2Width);
          const serviceDisplay = (info.service || 'N/A').substring(0, col3Width - 2).padEnd(col3Width);
          const centerDisplay = (info.center || 'N/A').substring(0, col4Width - 2).padEnd(col4Width);
          
          tableContent += `| ${maladieDisplay} | ${countDisplay} | ${serviceDisplay} | ${centerDisplay} |\n`;
        });
        
        tableContent += createSeparator();
      }
      
      if (diseaseStatsDiv) {
        diseaseStatsDiv.innerHTML = `<pre class="font-mono text-sm">${tableContent}</pre>`;
      }
    }

    // ================================
    // SAUVEGARDE ET CHARGEMENT (AMÉLIORÉ POUR INTEROPÉRABILITÉ)
    // ================================
    function saveData() {
      const data = { 
        patients, 
        consultations,
        lastSync: new Date().toISOString()
      };
      localStorage.setItem('medicalData', JSON.stringify(data));
      updateStats();
      populateRegistryFilters();
      
      // Ajouter à la file d'attente de synchronisation
      syncQueue.push(data);
      if (!isSyncing) {
        syncWithServer();
      }
    }

    function loadData() {
      const saved = localStorage.getItem('medicalData');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          patients = data.patients || [];
          consultations = data.consultations || [];
        } catch (e) {
          console.error('Erreur de chargement des données:', e);
          patients = [];
          consultations = [];
        }
      }
      
      // Charger également les données du serveur (simulation)
      const serverData = localStorage.getItem('serverData');
      if (serverData) {
        try {
          const parsedServerData = JSON.parse(serverData);
          mergeData(parsedServerData);
        } catch (e) {
          console.error('Erreur de chargement des données serveur:', e);
        }
      }
    }

    // ================================
    // EXPORT CSV
    // ================================
    function exportData() {
      const diseaseSearch = document.getElementById('diseaseSearchInput')?.value.toLowerCase() || '';
      const dateStart = document.getElementById('dateFilterStart')?.value || '';
      const dateEnd = document.getElementById('dateFilterEnd')?.value || '';
      const centerFilterValue = document.getElementById('centerFilter')?.value || 'all';
      const serviceFilterValue = document.getElementById('serviceFilter')?.value || 'all';
      
      const filteredConsultations = consultations.filter(c => {
        if (diseaseSearch && !c.disease.toLowerCase().includes(diseaseSearch)) return false;
        if (dateStart && new Date(c.date) < new Date(dateStart)) return false;
        if (dateEnd) {
          const endDate = new Date(dateEnd);
          endDate.setDate(endDate.getDate() + 1);
          if (new Date(c.date) >= endDate) return false;
        }
        if (centerFilterValue !== 'all' && c.center !== centerFilterValue) return false;
        if (serviceFilterValue !== 'all' && c.service !== serviceFilterValue) return false;
        return true;
      });

      if (filteredConsultations.length === 0) {
        showNotification('Aucune donnée à exporter avec les filtres actuels.', 'warning');
        return;
      }

      let csvContent = 'ID Patient,Nom,Âge,Sexe,Groupe Sanguin,Date,Maladie,Service,Centre,Médecin,Prescription\n';
      
      filteredConsultations.forEach(c => {
        const patient = patients.find(p => p.id === c.patientId);
        const ageDisplay = patient?.ageUnit ? 
          `${patient.age} ${patient.ageUnit}` : 
          `${patient.age} ans`;
        
        const row = [
          `"${c.patientId}"`,
          `"${patient ? patient.name : 'N/A'}"`,
          `"${ageDisplay}"`,
          `"${patient?.gender === 'M' ? 'M' : 'F'}"`,
          `"${patient?.bloodGroup || 'N/A'}"`,
          `"${c.date}"`,
          `"${c.disease}"`,
          `"${c.service}"`,
          `"${c.center}"`,
          `"${c.doctorName}"`,
          `"${c.prescriptionContent.replace(/"/g, '""')}"`
        ].join(',');
        csvContent += row + '\n';
      });

      const BOM = "\uFEFF";
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `export_medical_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('Export CSV réussi !', 'success');
    }

    // ================================
    // PARAMÈTRES
    // ================================
    function populateProfileForm() {
      if (!storedUser) return;
      
      const editFirstName = document.getElementById('editFirstName');
      const editLastName = document.getElementById('editLastName');
      const editUsername = document.getElementById('editUsername');
      const editEmail = document.getElementById('editEmail');
      const editPhone = document.getElementById('editPhone');
      const editRole = document.getElementById('editRole');
      const editService = document.getElementById('editService');
      
      if (editFirstName) editFirstName.value = storedUser.firstName || '';
      if (editLastName) editLastName.value = storedUser.lastName || '';
      if (editUsername) editUsername.value = storedUser.username || '';
      if (editEmail) editEmail.value = storedUser.email || '';
      if (editPhone) editPhone.value = storedUser.phone || '';
      if (editRole) editRole.value = storedUser.role || 'Autre';
      if (editService) editService.value = storedUser.service || 'Autre';
      
      const profileAlert = document.getElementById('profileAlert');
      if (profileAlert) profileAlert.innerHTML = '';
    }

    // ================================
    // INITIALISATION
    // ================================
    window.onload = function() {
      checkAuth();
      
      // Initialiser les écouteurs d'événements
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          if (window.debouncedSearch) window.debouncedSearch();
        });
      }
      
      const diseaseSearchInput = document.getElementById('diseaseSearchInput');
      if (diseaseSearchInput) {
        diseaseSearchInput.addEventListener('input', () => {
          if (window.debouncedUpdateStats) window.debouncedUpdateStats();
        });
      }
      
      const dateFilterStart = document.getElementById('dateFilterStart');
      if (dateFilterStart) {
        dateFilterStart.addEventListener('input', () => {
          if (window.debouncedUpdateStats) window.debouncedUpdateStats();
        });
      }
      
      const dateFilterEnd = document.getElementById('dateFilterEnd');
      if (dateFilterEnd) {
        dateFilterEnd.addEventListener('input', () => {
          if (window.debouncedUpdateStats) window.debouncedUpdateStats();
        });
      }
      
      const centerFilter = document.getElementById('centerFilter');
      if (centerFilter) {
        centerFilter.addEventListener('change', () => {
          if (window.debouncedUpdateStats) window.debouncedUpdateStats();
        });
      }
      
      const serviceFilter = document.getElementById('serviceFilter');
      if (serviceFilter) {
        serviceFilter.addEventListener('change', () => {
          if (window.debouncedUpdateStats) window.debouncedUpdateStats();
        });
      }
      
      // Ajouter un gestionnaire pour les inputs en majuscules
      document.querySelectorAll('.uppercase-input').forEach(input => {
        input.addEventListener('input', function() {
          this.value = this.value.toUpperCase();
        });
      });
    };
  </script>
</body>
</html>
